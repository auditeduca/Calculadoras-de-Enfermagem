<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
  <!-- ... (head igual ao original, mantendo todas as meta tags) ... -->
  
  <!-- Adicionar referência aos novos módulos -->
  <script src="modal-reference.js" defer></script>
  <script src="pdf-generator.js" defer></script>
  
  <script>
    // Configuração do sistema corrigido
    const CALCULATOR_SYSTEM = {
      // ... (todo o código do DYNAMIC_CALCULATOR_SYSTEM original) ...
      
      // CORREÇÃO 1: Botão Simulados
      redirectSimulados() {
        window.open('https://simulados-para-enfermagem.com.br/', '_blank', 'noopener,noreferrer');
      },

      // CORREÇÃO 2: Label Data de Nascimento
      createBirthdateField() {
        return `
          <div>
            <label for="patient_birthdate" class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
              Data de Nascimento <span class="text-red-500">*</span>
              <i class="fa-solid fa-circle-info label-tooltip" title="Para cálculo de idade e verificação de faixa etária"></i>
            </label>
            <input id="patient_birthdate" type="date" 
                   max="${new Date().toISOString().split('T')[0]}" 
                   class="input-field" required />
          </div>
        `;
      },

      // CORREÇÃO 3: Gerar PDF usando novo sistema
      async gerarPDF() {
        if (!this.data || !this.currentCalculator) {
          this.showNotification('Realize um cálculo primeiro');
          return;
        }

        try {
          this.showNotification('Gerando PDF...');
          
          const patientData = {
            name: document.getElementById('patient_name')?.value || 'Não informado',
            birthdate: document.getElementById('patient_birthdate')?.value || 'Não informado'
          };

          await PDF_SYSTEM.generate(
            this.currentCalculator.name,
            this.data,
            patientData
          );
          
          this.showNotification('PDF gerado com sucesso!', 'success');
          
        } catch (error) {
          console.error('Erro ao gerar PDF:', error);
          this.showNotification('Erro ao gerar PDF');
        }
      },

      // CORREÇÃO 4: Copiar resultado
      copiarResumo() {
        if (!this.data) {
          this.showNotification('Nenhum resultado para copiar');
          return;
        }

        try {
          let text = `REGISTRO DE CÁLCULO - ${this.currentCalculator.name}\n`;
          text += `Data: ${new Date().toLocaleString('pt-BR')}\n`;
          text += `Paciente: ${document.getElementById('patient_name')?.value || 'Não informado'}\n`;
          text += `Nascimento: ${document.getElementById('patient_birthdate')?.value || 'Não informado'}\n\n`;
          
          Object.keys(this.data).forEach(key => {
            if (!['calculator', 'timestamp'].includes(key)) {
              text += `${this.formatLabel(key)}: ${this.data[key]}\n`;
            }
          });
          
          navigator.clipboard.writeText(text).then(() => {
            this.showNotification('Resultado copiado!', 'success');
          }).catch(err => {
            console.error('Erro ao copiar:', err);
            this.showNotification('Erro ao copiar texto');
          });
          
        } catch (error) {
          console.error('Erro:', error);
          this.showNotification('Erro ao copiar');
        }
      },

      // CORREÇÃO 5: Botão Diagnóstico NANDA
      buscarDiagnosticoNANDA() {
        if (!this.currentCalculator) return;
        
        REFERENCE_MODALS.open('diagnosticoNANDA');
        
        // Alternativamente, busca online
        // const query = encodeURIComponent(`NANDA diagnóstico enfermagem ${this.currentCalculator.name}`);
        // window.open(`https://www.google.com/search?q=${query}`, '_blank');
      },

      // CORREÇÃO 6: Prevenir números negativos em todos os campos
      createFieldsHTML(fields) {
        return fields.map(field => {
          let html = '';
          if (field.type === 'select') {
            html = `
              <div>
                <label for="${field.id}" class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
                  ${field.name} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                </label>
                <select id="${field.id}" class="input-field" ${field.required ? 'required' : ''}>
                  <option value="">Selecione</option>
                  ${field.options.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                </select>
              </div>
            `;
          } else if (field.type === 'date') {
            html = `
              <div>
                <label for="${field.id}" class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
                  ${field.name} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                </label>
                <input id="${field.id}" type="date" 
                       max="${new Date().toISOString().split('T')[0]}" 
                       class="input-field" ${field.required ? 'required' : ''}/>
              </div>
            `;
          } else {
            // Para campos numéricos, prevenir números negativos
            const inputType = field.type || 'number';
            const step = field.type === 'decimal' ? '0.01' : '1';
            
            html = `
              <div>
                <label for="${field.id}" class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
                  ${field.name} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                  ${field.tooltip ? `<i class="fa-solid fa-circle-info label-tooltip" title="${field.tooltip}"></i>` : ''}
                </label>
                <input id="${field.id}" type="${inputType}" 
                       min="0" 
                       step="${step}"
                       placeholder="${field.placeholder || ''}" 
                       class="input-field" 
                       oninput="this.value = this.value.replace(/[^0-9.,]/g, '')"
                       onkeydown="return event.key !== '-' && event.key !== 'e' && event.key !== '+'"
                       ${field.required ? 'required' : ''}/>
                ${field.unit ? `<span class="text-xs text-slate-500 mt-1">${field.unit}</span>` : ''}
              </div>
            `;
          }
          return html;
        }).join('');
      },

      // CORREÇÃO 7: Renderizar todas as seções corretamente
      renderCalculator(calc) {
        // ... (código original) ...
        
        // Adicionar botão NANDA na seção de resultados
        const actionButtons = `
          <div class="flex flex-wrap gap-4 justify-center mb-10">
            <button onclick="CALCULATOR_SYSTEM.gerarPDF()" class="btn-primary-action px-10">
              <i class="fa-solid fa-file-pdf"></i> Gerar PDF
            </button>
            <button onclick="CALCULATOR_SYSTEM.copiarResumo()" class="btn-secondary-action px-8">
              <i class="fa-solid fa-copy"></i> Copiar Resultado
            </button>
            <button onclick="CALCULATOR_SYSTEM.buscarDiagnosticoNANDA()" class="btn-secondary-action px-8 bg-nurse-accent text-white hover:bg-nurse-primary">
              <i class="fa-solid fa-stethoscope"></i> Diagnóstico NANDA
            </button>
          </div>
        `;
        
        // Adicionar botões de referência nas seções de checklist
        const checklistHeaders = `
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 flex items-center gap-2">
              <i class="fa-solid fa-check-double"></i> 9 Certos da Medicação
            </h3>
            <button onclick="REFERENCE_MODALS.open('certosMedicacao')" class="text-xs text-nurse-secondary hover:text-nurse-primary font-bold">
              <i class="fa-solid fa-circle-info mr-1"></i> Ver Referência
            </button>
          </div>
          
          <div class="flex justify-between items-center mb-4 mt-8">
            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 flex items-center gap-2">
              <i class="fa-solid fa-star"></i> Metas Internacionais de Segurança
            </h3>
            <button onclick="REFERENCE_MODALS.open('metasSeguranca')" class="text-xs text-nurse-secondary hover:text-nurse-primary font-bold">
              <i class="fa-solid fa-circle-info mr-1"></i> Ver Referência
            </button>
          </div>
        `;
        
        // Adicionar seção do autor e tags
        this.renderAuthorSection();
      },

      // Nova função para renderizar seção do autor
      renderAuthorSection() {
        const authorHTML = `
          <section class="max-w-7xl mx-auto px-4 py-12 border-t border-slate-200 dark:border-slate-800 mt-12">
            <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] p-10 flex flex-col md:flex-row gap-10 items-center border border-slate-200 dark:border-slate-700 shadow-sm">
              <div class="relative flex-shrink-0">
                <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-white dark:border-slate-700 shadow-xl">
                  <img src="https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/images/author-info.webp" 
                       alt="Autor" 
                       class="w-full h-full object-cover"/>
                </div>
              </div>
              <div class="text-center md:text-left">
                <h3 class="text-2xl font-black mb-3 text-nurse-primary dark:text-cyan-400 font-nunito">
                  Calculadoras de Enfermagem
                </h3>
                <p class="text-slate-600 dark:text-slate-300 text-lg leading-relaxed max-w-2xl font-inter italic">
                  "A precisão técnica é a expressão máxima do cuidado ético ao paciente."
                </p>
                <div class="mt-4 flex flex-wrap gap-2">
                  <span class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center">
                    <i class="fa-solid fa-tags mr-2"></i> Tópicos:
                  </span>
                  <span id="tags-container" class="flex flex-wrap gap-2">
                    <!-- Tags serão preenchidas dinamicamente -->
                  </span>
                </div>
              </div>
            </div>
          </section>
        `;
        
        // Inserir após a seção de resultados
        const mainContent = document.querySelector('main');
        if (mainContent) {
          mainContent.insertAdjacentHTML('beforeend', authorHTML);
        }
      },

      // Função auxiliar para mostrar notificações
      showNotification(message, type = 'info') {
        REFERENCE_MODALS.showNotification(message, type);
      }
    };

    // Substituir o sistema antigo pelo novo
    window.DYNAMIC_CALCULATOR_SYSTEM = CALCULATOR_SYSTEM;
  </script>
  
  <style>
    /* Estilos adicionais para correções */
    .input-field:invalid {
      border-color: #ef4444;
      background-color: #fef2f2;
    }
    
    .dark .input-field:invalid {
      border-color: #dc2626;
      background-color: #7f1d1d20;
    }
    
    .required-field::after {
      content: " *";
      color: #ef4444;
      font-weight: bold;
    }
    
    /* Estilo para botões de referência */
    .reference-btn {
      transition: all 0.3s ease;
    }
    
    .reference-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <!-- ... (restante do corpo igual ao original) ... -->
  
  <script>
    // Inicialização corrigida
    document.addEventListener('DOMContentLoaded', () => {
      // Aguardar carregamento dos módulos
      setTimeout(() => {
        if (window.CALCULATOR_SYSTEM) {
          CALCULATOR_SYSTEM.init();
        } else if (window.DYNAMIC_CALCULATOR_SYSTEM) {
          DYNAMIC_CALCULATOR_SYSTEM.init();
        }
        
        // Inicializar modais de referência
        if (window.REFERENCE_MODALS) {
          REFERENCE_MODALS.init();
        }
      }, 1000);
    });
    
    // Funções globais corrigidas
    function share(platform) {
      const url = encodeURIComponent(window.location.href);
      const title = encodeURIComponent(document.title);
      
      const urls = {
        facebook: `https://www.facebook.com/sharer/sharer.php?u=${url}`,
        whatsapp: `https://api.whatsapp.com/send?text=${title}%20${url}`,
        linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${url}`,
        twitter: `https://twitter.com/intent/tweet?text=${title}&url=${url}`
      };
      
      if (urls[platform]) {
        window.open(urls[platform], '_blank', 'width=600,height=400,noopener,noreferrer');
      }
    }
    
    function copyLink() {
      navigator.clipboard.writeText(window.location.href)
        .then(() => {
          if (window.REFERENCE_MODALS) {
            REFERENCE_MODALS.showNotification('Link copiado!', 'success');
          }
        })
        .catch(err => console.error('Erro ao copiar:', err));
    }
  </script>
</body>
</html>