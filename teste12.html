<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <title id="page-title">Calculadoras de Enfermagem</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@700;800;900&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  
  <!-- Estilos Originais (URLs Absolutas) -->
  <link rel="stylesheet" href="https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/css/variables-v4.css"/>
  <link rel="stylesheet" href="https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/css/header-v4.css"/>
  <link rel="stylesheet" href="https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/css/footer-v4.css"/>
  <link rel="stylesheet" href="https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/css/accessibility-v4.css"/>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Bibliotecas Externas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { nunito: ['"Nunito Sans"','sans-serif'], inter: ['Inter','sans-serif'] },
          colors: { 
            'nurse-primary':'#1A3E74', 
            'nurse-secondary':'#00bcd4', 
            'nurse-accent':'#00838f', 
            'nurse-bgDark':'#0F172A' 
          },
          animation: {
            'slide-in': 'slideIn 0.3s ease-out',
            'fade-in': 'fadeIn 0.3s ease-out',
          }
        }
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer base {
      body { @apply bg-slate-50 text-slate-900 dark:bg-nurse-bgDark dark:text-slate-100 antialiased font-inter relative transition-colors duration-300; }
      h1 { @apply font-nunito font-black tracking-tight text-nurse-primary dark:text-cyan-400; }
      h2, h3 { @apply font-inter tracking-tight text-nurse-primary dark:text-cyan-400 font-extrabold; }
    }
    @layer components {
      .card-base { @apply bg-white dark:bg-slate-800/90 rounded-[2rem] border border-slate-200 dark:border-slate-700 shadow-sm transition-all overflow-hidden; }
      .sidebar-module { @apply rounded-2xl p-6 shadow-lg text-white bg-gradient-to-br from-[#1A3E74] to-[#2E5A9C] dark:from-[#1e293b] dark:to-[#0f172a] mb-6; }
      .input-field { @apply w-full bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 focus:border-nurse-secondary outline-none transition-all font-medium; }
      .btn-primary-action { @apply bg-nurse-primary hover:bg-nurse-secondary text-white font-bold py-4 px-8 rounded-2xl shadow-xl transition-all active:scale-[0.98] flex items-center justify-center gap-2 text-sm uppercase tracking-wider disabled:opacity-50 disabled:cursor-not-allowed; }
      .btn-secondary-action { @apply bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200 font-bold py-4 rounded-2xl transition-all flex items-center justify-center gap-2 text-sm uppercase tracking-wider; }
      .tab-btn { @apply flex-1 px-2 py-3 font-bold text-[10px] transition-all border-b-4 border-transparent text-slate-400 hover:text-nurse-primary whitespace-nowrap text-center uppercase tracking-wider; }
      .tab-btn.active { @apply border-nurse-secondary text-nurse-primary dark:text-cyan-400 bg-slate-50/50 dark:bg-slate-900/30; }
      .glass-meta { @apply relative backdrop-blur-md border border-white/20 p-4 rounded-xl shadow-sm transition-all duration-300 flex items-center gap-4; }
      .glass-meta-blue { @apply bg-blue-50 dark:bg-blue-900/20 text-blue-900 dark:text-blue-100 border-l-4 border-blue-500; }
      .glass-meta-orange { @apply bg-orange-50 dark:bg-orange-900/20 text-orange-900 dark:text-orange-100 border-l-4 border-orange-500; }
      .toast-msg { @apply pointer-events-auto bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 font-bold text-sm min-w-[320px] border-l-4 border-nurse-secondary animate-slide-in; }
      .tag-pill-footer { @apply px-3 py-1.5 bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-300 rounded-lg text-[11px] font-bold hover:bg-nurse-accent hover:text-white transition-all cursor-pointer; }
      .share-btn { @apply w-10 h-10 rounded-full flex items-center justify-center bg-white/10 text-white hover:bg-white hover:text-nurse-primary transition-all shadow-md; }
    }

    .sidebar-left-tools {
        position: fixed; left: 0; top: 50%; transform: translateY(-50%);
        display: flex; flex-direction: column; gap: 12px; z-index: 1000; padding: 10px 0;
    }
    .tool-btn {
        background-color: white; color: #1A3E74; border: 1px solid #e2e8f0;
        border-left: none; width: 54px; height: 54px; border-radius: 0 14px 14px 0;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 4px 0 10px rgba(0, 0, 0, 0.05); transition: all 0.3s;
        position: relative;
    }
    .btn-label {
        display: none; position: absolute; left: 60px; background: #1A3E74;
        color: white; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: bold;
        white-space: nowrap; pointer-events: none;
    }
    .tool-btn:hover { width: 65px; background-color: #1A3E74; color: #ffffff; }
    .tool-btn:hover .btn-label { display: block; }

    @media (max-width: 768px) {
        .sidebar-left-tools {
            top: auto; bottom: 0; left: 0; width: 100%; height: 70px;
            flex-direction: row; transform: none; justify-content: space-around;
            align-items: center; background: white; border-top: 1px solid #e2e8f0;
            border-radius: 0; box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.08); padding: 0 5px;
        }
        .tool-btn { border: none; width: auto; height: auto; gap: 4px; box-shadow: none; background: transparent; border-radius: 0; }
        .btn-label { display: block; position: static; background: transparent; color: currentColor; font-size: 9px; }
        body { padding-bottom: 80px; }
    }

    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateX(0); } }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- MÓDULOS DE SISTEMA (HEADER, FOOTER, ACESSIBILIDADE) -->
  <div id="accessibility-container"></div>
  <div id="notification-container" class="fixed top-6 right-6 z-[10000] flex flex-col gap-3 pointer-events-none"></div>
  <div id="header-container" class="sticky top-0 z-50 bg-white dark:bg-nurse-bgDark shadow-sm"></div>

  <!-- BARRA LATERAL DE FERRAMENTAS -->
  <aside class="sidebar-left-tools" id="sidebar-tools">
      <button class="tool-btn" id="btn-conteudo" title="Conteúdo">
          <i class="fas fa-book-open"></i>
          <span class="btn-label">Conteúdo</span>
      </button>
      <button class="tool-btn" id="btn-nanda" title="Diagnósticos NANDA">
          <i class="fas fa-stethoscope"></i>
          <span class="btn-label">Nanda</span>
      </button>
      <button class="tool-btn" id="btn-9acertos" title="9 Acertos">
          <i class="fas fa-check-double"></i>
          <span class="btn-label">9 Acertos</span>
      </button>
      <button class="tool-btn" id="btn-metas" title="Metas">
          <i class="fas fa-bullseye"></i>
          <span class="btn-label">Metas</span>
      </button>
  </aside>

  <main id="main-content" class="flex-grow max-w-7xl mx-auto px-4 pt-8 pb-8 md:py-12 w-full">
    
    <!-- BREADCRUMB -->
    <nav id="breadcrumb" class="mb-8 font-semibold">
        <div class="hidden md:flex items-center gap-2 text-sm text-slate-600 dark:text-cyan-300" id="breadcrumb-list">
            <!-- Dinâmico -->
        </div>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <!-- COLUNA PRINCIPAL -->
      <div class="lg:col-span-8 space-y-8">
        
        <!-- HEADER DA CALCULADORA -->
        <header class="space-y-4">
          <div class="flex items-center gap-3">
            <span id="calc-badge" class="px-4 py-1.5 bg-nurse-secondary/10 text-nurse-secondary text-[10px] font-black uppercase tracking-widest rounded-full border border-nurse-secondary/20">
              <!-- Dinâmico -->
            </span>
            <span id="calc-version" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
              <!-- Dinâmico -->
            </span>
          </div>
          <h1 id="calc-title" class="text-4xl md:text-5xl lg:text-6xl">
            <!-- Dinâmico -->
          </h1>
          <p id="calc-description" class="text-lg text-slate-600 dark:text-slate-400 max-w-2xl leading-relaxed">
            <!-- Dinâmico -->
          </p>
        </header>

        <!-- CARD PRINCIPAL -->
        <div class="card-base">
          <!-- TABS -->
          <div class="flex border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 overflow-x-auto no-scrollbar" id="tabs-container">
            <!-- Dinâmico -->
          </div>

          <!-- CONTEÚDO DAS TABS -->
          <div class="p-6 md:p-10">
            
            <!-- ABA CALCULADORA -->
            <div id="pane-calc" class="tab-pane space-y-8">
              <div id="calculator-fields" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Dinâmico -->
              </div>

              <div class="flex flex-col sm:flex-row gap-4 pt-4" id="calc-buttons">
                <!-- Dinâmico -->
              </div>

              <!-- RESULTADOS -->
              <div id="results-wrapper" class="hidden mt-12 space-y-8 animate-fade-in">
                <div class="bg-gradient-to-br from-nurse-primary to-nurse-accent rounded-[2.5rem] p-8 md:p-12 text-white shadow-2xl relative overflow-hidden">
                  <div class="relative z-10 text-center space-y-4">
                    <p class="text-xs font-black uppercase tracking-[0.3em] opacity-80">Volume Final a Aspirar</p>
                    <div class="flex items-baseline justify-center gap-2">
                      <span id="res-total" class="text-7xl md:text-9xl font-black tracking-tighter">0.00</span>
                      <span class="text-2xl md:text-4xl font-bold opacity-60">mL</span>
                    </div>
                  </div>
                </div>

                <!-- AUDITORIA -->
                <div class="space-y-6">
                  <h3 class="flex items-center gap-3 text-xl">
                    <i class="fa-solid fa-clipboard-check text-nurse-secondary"></i>
                    Auditoria do Cálculo
                  </h3>
                  <ul id="audit-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Dinâmico -->
                  </ul>
                </div>

                <!-- CHECKLISTS -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                  <div class="space-y-6">
                    <h3 class="text-lg">9 Certos da Medicação</h3>
                    <div id="checklist-9certos" class="grid grid-cols-1 gap-2">
                      <!-- Dinâmico -->
                    </div>
                  </div>
                  <div class="space-y-6">
                    <h3 class="text-lg">Metas de Segurança</h3>
                    <div id="checklist-metas" class="flex flex-col gap-3">
                      <!-- Dinâmico -->
                    </div>
                  </div>
                </div>

                <!-- AÇÕES DE RESULTADO -->
                <div class="flex flex-wrap gap-4 pt-6" id="result-actions">
                  <!-- Dinâmico -->
                </div>
              </div>
            </div>

            <!-- ABA SOBRE -->
            <div id="pane-sobre" class="tab-pane hidden prose dark:prose-invert max-w-none">
              <div id="content-sobre"></div>
            </div>

            <!-- ABA INSTRUÇÕES -->
            <div id="pane-ajuda" class="tab-pane hidden prose dark:prose-invert max-w-none">
              <div id="content-ajuda"></div>
            </div>

            <!-- ABA REFERÊNCIAS -->
            <div id="pane-referencia" class="tab-pane hidden prose dark:prose-invert max-w-none">
              <div id="content-referencia"></div>
            </div>

          </div>
        </div>

        <!-- SEÇÃO AUTOR E TAGS -->
        <footer class="pt-12 border-t border-slate-200 dark:border-slate-800 space-y-8">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div class="flex items-center gap-4">
              <img src="https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/images/author-info.webp" class="w-16 h-16 rounded-2xl shadow-lg" alt="Autor"/>
              <div>
                <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Publicado por</p>
                <p class="font-bold text-nurse-primary dark:text-cyan-400" id="calc-author">Calculadoras de Enfermagem</p>
              </div>
            </div>
            <div id="calc-tags" class="flex flex-wrap gap-2">
              <!-- Dinâmico -->
            </div>
          </div>
        </footer>
      </div>

      <!-- SIDEBAR DIREITO -->
      <aside class="lg:col-span-4 space-y-6">
        <div id="sidebar-right-content">
            <!-- Dinâmico -->
        </div>
      </aside>

    </div>
  </main>

  <!-- FOOTER CONTAINER -->
  <div id="footer-container"></div>

  <!-- MODAL -->
  <div id="reference-modal" class="fixed inset-0 z-[10000] hidden flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden animate-fade-in">
      <div class="p-8 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-nurse-primary/10 rounded-2xl flex items-center justify-center">
            <i id="modal-icon" class="fa-solid fa-book text-nurse-primary dark:text-cyan-400 text-xl"></i>
          </div>
          <h2 id="modal-title" class="text-2xl">Título do Modal</h2>
        </div>
        <button onclick="SYSTEM.closeModal()" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors flex items-center justify-center">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div id="modal-content-area" class="p-8 max-h-[60vh] overflow-y-auto custom-scrollbar">
        <!-- Dinâmico -->
      </div>
    </div>
  </div>

  <!-- TEMPLATE PARA PDF -->
  <div id="pdf-render-template" class="fixed -left-[9999px] top-0 bg-white w-[595px] p-10 font-inter text-slate-900">
    <div style="border-bottom: 2px solid #1A3E74; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 style="margin: 0; font-size: 24px; color: #1A3E74;">RELATÓRIO DE AUDITORIA</h1>
        <p style="margin: 5px 0 0 0; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase;">Calculadoras de Enfermagem Profissional</p>
      </div>
      <div style="text-align: right;">
        <p id="pdf-date" style="margin: 0; font-size: 10px; font-weight: 700;"></p>
      </div>
    </div>
    <div id="pdf-body"></div>
    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center; font-size: 8px; color: #94a3b8;">
      Este documento é um registro digital de conferência e deve ser anexado ao prontuário se aplicável.
    </div>
  </div>

  <!-- Scripts de Componentes (URLs Absolutas) -->
  <script src="https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/js/event-bus-v4.js"></script>
  <script src="https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/js/header-v4.js"></script>
  <script src="https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/js/footer-v4.js"></script>
  <script src="https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/js/accessibility-v4.js"></script>

  <script>
    const SYSTEM = {
        data: {},
        lastResult: null,

        async init() {
            try {
                await this.loadComponents();
                await this.loadAllData();
                this.renderUI();
                this.setupEventListeners();
                this.notify("Sistema carregado com sucesso.", "success");
            } catch (error) {
                console.error("Erro ao inicializar:", error);
                this.notify("Erro ao carregar dados externos.", "error");
            }
        },

        async loadComponents() {
            // Carregar Header, Footer e Acessibilidade via fetch
            const components = [
                { id: 'header-container', url: 'https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/components/header-v4.html' },
                { id: 'footer-container', url: 'https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/components/footer-v4.html' },
                { id: 'accessibility-container', url: 'https://auditeduca.github.io/Calculadoras-de-Enfermagem/assets/components/accessibility-v4.html' }
            ];

            const loadPromises = components.map(async (comp) => {
                const response = await fetch(comp.url);
                const html = await response.text();
                document.getElementById(comp.id).innerHTML = html;
            });

            await Promise.all(loadPromises);
        },

        async loadAllData() {
            const urls = {
                content: 'https://auditeduca.github.io/Calculadoras-de-Enfermagem/data/content-calculators.json',
                ipsg: 'https://auditeduca.github.io/Calculadoras-de-Enfermagem/data/IPSG.json',
                rightForm: 'https://auditeduca.github.io/Calculadoras-de-Enfermagem/data/Right_Form.json',
                shared: 'https://auditeduca.github.io/Calculadoras-de-Enfermagem/data/shared-components.json',
                calculators: 'https://auditeduca.github.io/Calculadoras-de-Enfermagem/data/nursing_calculators.json',
                nanda: 'https://auditeduca.github.io/Calculadoras-de-Enfermagem/data/nanda.json'
            };

            const fetchPromises = Object.entries(urls).map(async ([key, url]) => {
                const response = await fetch(url);
                this.data[key] = await response.json();
            });

            await Promise.all(fetchPromises);
        },

        renderUI() {
            const calc = this.data.calculators.calculadora;
            
            // Header & SEO
            document.title = `${calc.titulo} | Calculadoras de Enfermagem`;
            document.getElementById('calc-title').innerText = calc.titulo;
            document.getElementById('calc-description').innerText = calc.descricao;
            document.getElementById('calc-badge').innerText = calc.badge;
            document.getElementById('calc-version').innerText = `v${calc.versao}`;
            
            // Breadcrumb
            const bcList = document.getElementById('breadcrumb-list');
            bcList.innerHTML = calc.breadcrumbs.desktop.map((item, index) => `
                <span>${item}</span>
                ${index < calc.breadcrumbs.desktop.length - 1 ? '<i class="fa-solid fa-chevron-right text-[8px] opacity-40"></i>' : ''}
            `).join('');

            // Tabs
            const tabsContainer = document.getElementById('tabs-container');
            const tabs = this.data.calculators.sidebar_esquerdo.find(s => s.id === 'conteudo').items;
            tabsContainer.innerHTML = tabs.map(tab => `
                <button id="btn-tab-${tab.tab}" onclick="SYSTEM.switchTab('${tab.tab}')" class="tab-btn ${tab.ativo ? 'active' : ''}">
                    <i class="fa-solid ${tab.icone} mr-2"></i>${tab.label}
                </button>
            `).join('');

            // Calculator Fields
            const fieldsContainer = document.getElementById('calculator-fields');
            const sections = this.data.calculators.campos_calculadora;
            fieldsContainer.innerHTML = sections.map(section => `
                <div class="space-y-4 col-span-full md:col-span-1">
                    <h3 class="text-sm uppercase tracking-widest text-slate-400 font-black flex items-center gap-2">
                        <i class="fa-solid ${section.icone}"></i> ${section.secao}
                    </h3>
                    ${section.campos.map(field => this.renderField(field)).join('')}
                </div>
            `).join('');

            // Calculator Buttons
            const buttonsContainer = document.getElementById('calc-buttons');
            const buttons = this.data.calculators.botoes_calculo;
            buttonsContainer.innerHTML = buttons.map(btn => `
                <button onclick="SYSTEM.${btn.id}()" class="${btn.id === 'calcular' ? 'btn-primary-action flex-1' : 'btn-secondary-action px-8'}">
                    <i class="fa-solid ${btn.icone}"></i> ${btn.label}
                </button>
            `).join('');

            // Sidebar Right
            const sidebarRight = document.getElementById('sidebar-right-content');
            const shared = this.data.shared;
            sidebarRight.innerHTML = `
                <div class="sidebar-module">
                    <h3 class="text-white mb-4">Simulados</h3>
                    <p class="text-xs opacity-80 mb-6">Prepare-se para concursos e residências com nossas questões comentadas.</p>
                    <button class="w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition-all border border-white/20">Acessar Simulados</button>
                </div>
                <div class="card-base p-6 space-y-6">
                    <h3 class="text-sm">Compartilhar</h3>
                    <div class="flex gap-3">
                        <button onclick="SYSTEM.share('whatsapp')" class="share-btn bg-[#25D366]"><i class="fa-brands fa-whatsapp"></i></button>
                        <button onclick="SYSTEM.share('facebook')" class="share-btn bg-[#1877F2]"><i class="fa-brands fa-facebook-f"></i></button>
                        <button onclick="SYSTEM.share('linkedin')" class="share-btn bg-[#0A66C2]"><i class="fa-brands fa-linkedin-in"></i></button>
                    </div>
                </div>
            `;

            // Tags
            const tagsContainer = document.getElementById('calc-tags');
            tagsContainer.innerHTML = calc.tags.map(tag => `<span class="tag-pill-footer">${tag}</span>`).join('');

            // Content for Tabs
            document.getElementById('content-sobre').innerHTML = `<p>${this.data.content.conteudo_tecnico.identificacao.definicao}</p>`;
            document.getElementById('content-ajuda').innerHTML = `<ul>${this.data.content.conteudo_tecnico.objetivos.finalidade.map(f => `<li>${f}</li>`).join('')}</ul>`;
            document.getElementById('content-referencia').innerHTML = `<ul>${this.data.content.conteudo_tecnico.referencias.map(r => `<li>${r}</li>`).join('')}</ul>`;
        },

        renderField(field) {
            if (field.tipo === 'select') {
                return `
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">${field.label}</label>
                        <select id="${field.id}" class="input-field">
                            ${field.opcoes.map(opt => `<option value="${opt.value}" ${opt.default ? 'selected' : ''}>${opt.label}</option>`).join('')}
                        </select>
                    </div>
                `;
            }
            return `
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">${field.label}</label>
                    <input type="${field.tipo}" id="${field.id}" placeholder="${field.placeholder || ''}" class="input-field" />
                </div>
            `;
        },

        setupEventListeners() {
            document.getElementById('btn-conteudo').onclick = () => {
                const content = this.data.content;
                this.openModal(content.titulo, "fa-book-open", `
                    <div class="space-y-4">
                        <p class="font-bold">${content.descricao_curta}</p>
                        <div class="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl">
                            <h4 class="font-black text-xs uppercase mb-2">Definição</h4>
                            <p class="text-sm">${content.conteudo_tecnico.identificacao.definicao}</p>
                        </div>
                    </div>
                `);
            };

            document.getElementById('btn-nanda').onclick = () => {
                const nanda = this.data.nanda;
                this.openModal("Diagnósticos NANDA-I", "fa-stethoscope", `
                    <div class="space-y-6">
                        ${nanda.map(d => `
                            <div class="p-4 border-l-4 border-nurse-primary bg-slate-50 dark:bg-slate-900 rounded-r-xl">
                                <p class="font-black text-xs uppercase">${d.titulo} (${d.codigo})</p>
                                <p class="text-xs mt-1 opacity-70">${d.definicao}</p>
                            </div>
                        `).join('')}
                    </div>
                `);
            };

            document.getElementById('btn-9acertos').onclick = () => {
                const guide = this.data.shared.guias['9certos'];
                this.openModal(guide.titulo, "fa-check-double", `
                    <div class="space-y-4">
                        ${guide.conteudo_tecnico.os_9_acertos_detalhado.map(item => `
                            <div class="flex gap-4 p-3 bg-slate-50 dark:bg-slate-900 rounded-xl">
                                <span class="w-6 h-6 rounded-full bg-nurse-primary text-white flex items-center justify-center text-[10px] font-bold flex-shrink-0">${item.ordem}</span>
                                <div>
                                    <p class="font-bold text-sm">${item.item}</p>
                                    <p class="text-xs opacity-70">${item.verificacao}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `);
            };

            document.getElementById('btn-metas').onclick = () => {
                const guide = this.data.shared.guias['metas'];
                this.openModal(guide.titulo, "fa-bullseye", `
                    <div class="space-y-4">
                        ${guide.conteudo_tecnico.metas_detalhado.map(item => `
                            <div class="p-4 border-l-4 border-nurse-secondary bg-slate-50 dark:bg-slate-900 rounded-r-xl">
                                <p class="font-black text-xs uppercase">${item.ordem}. ${item.item}</p>
                                <p class="text-xs mt-1 opacity-70">${item.objetivo}</p>
                            </div>
                        `).join('')}
                    </div>
                `);
            };
        },

        calcular() {
            const prescricao = parseFloat(document.getElementById('prescricao_medica').value);
            const concentracao = parseFloat(document.getElementById('concentracao_insulina').value);

            if (isNaN(prescricao) || prescricao <= 0) {
                this.notify("Por favor, insira uma prescrição válida.", "error");
                return;
            }

            const volume = (prescricao / concentracao).toFixed(2);
            this.lastResult = { prescricao, concentracao, volume, data: new Date().toLocaleString() };

            document.getElementById('res-total').innerText = volume;
            document.getElementById('results-wrapper').classList.remove('hidden');
            this.renderAudit();
            this.renderChecklists();
            this.renderResultActions();
            
            this.notify("Cálculo realizado com sucesso.", "success");
            document.getElementById('results-wrapper').scrollIntoView({ behavior: 'smooth' });
        },

        renderAudit() {
            const list = document.getElementById('audit-list');
            const data = [
                { label: "Prescrição Médica", value: `${this.lastResult.prescricao} UI`, icon: "fa-file-medical" },
                { label: "Concentração", value: `${this.lastResult.concentracao} UI/mL`, icon: "fa-vial" },
                { label: "Volume Final", value: `${this.lastResult.volume} mL`, icon: "fa-check-double" },
                { label: "Data/Hora", value: this.lastResult.data, icon: "fa-clock" }
            ];

            list.innerHTML = data.map(item => `
                <li class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid ${item.icon} text-nurse-secondary"></i>
                        <span class="font-bold text-[10px] uppercase text-slate-400">${item.label}</span>
                    </div>
                    <span class="font-black text-nurse-primary dark:text-cyan-400 text-sm">${item.value}</span>
                </li>
            `).join('');
        },

        renderChecklists() {
            const certos = ["Paciente Certo", "Medicação Certa", "Dose Certa", "Via Certa", "Hora Certa", "Registro Certo", "Validade", "Resposta", "Orientação"];
            document.getElementById('checklist-9certos').innerHTML = certos.map(c => `
                <label class="flex items-center gap-3 p-3 bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-700 rounded-xl cursor-pointer text-[10px] font-black uppercase tracking-widest text-slate-500 hover:border-nurse-secondary transition group">
                    <input type="checkbox" class="w-4 h-4 accent-nurse-primary"/> 
                    <span>${c}</span>
                </label>
            `).join('');

            const metas = [
                { id: 1, text: "Identificar o paciente corretamente", class: "glass-meta-blue" },
                { id: 3, text: "Segurança de Medicamentos de Alta Vigilância", class: "glass-meta-orange" }
            ];
            document.getElementById('checklist-metas').innerHTML = metas.map(m => `
                <label class="glass-meta ${m.class} py-3 cursor-pointer group">
                    <input type="checkbox" class="w-4 h-4 accent-white mr-2"/>
                    <span class="text-[10px] uppercase font-black tracking-wider">${m.id}. ${m.text}</span>
                </label>
            `).join('');
        },

        renderResultActions() {
            const actionsContainer = document.getElementById('result-actions');
            const config = this.data.calculators.resultado_config.botoes_principais;
            actionsContainer.innerHTML = config.map(btn => `
                <button onclick="SYSTEM.${btn.id.replace('-', '')}()" class="btn-primary-action px-6 py-3 text-xs">
                    <i class="fa-solid ${btn.icone}"></i> ${btn.label}
                </button>
            `).join('');
        },

        limpar() {
            document.getElementById('prescricao_medica').value = '';
            document.getElementById('results-wrapper').classList.add('hidden');
            this.lastResult = null;
            this.notify("Campos resetados.", "info");
        },

        async gerarpdf() {
            if (!this.lastResult) return;
            this.notify('Gerando relatório...', 'info');
            const patient = document.getElementById('patient_name')?.value || "Não informado";
            const body = document.getElementById('pdf-body');
            document.getElementById('pdf-date').innerText = this.lastResult.data;
            
            body.innerHTML = `
                <div style="background:#f8fafc; padding:20px; border-radius:15px; margin-bottom:20px; border: 1px solid #e2e8f0;">
                    <p style="margin:0; font-size:10px; color:#64748b; font-weight:800; text-transform:uppercase;">Paciente</p>
                    <p style="margin:5px 0 0 0; font-size:14px; font-weight:900; color:#1A3E74;">${patient.toUpperCase()}</p>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:30px;">
                    <div style="padding:15px; background:#f1f5f9; border-radius:12px;">
                        <p style="margin:0; font-size:9px; color:#64748b; font-weight:800;">PRESCRIÇÃO</p>
                        <p style="margin:5px 0 0 0; font-size:16px; font-weight:900;">${this.lastResult.prescricao} UI</p>
                    </div>
                    <div style="padding:15px; background:#f1f5f9; border-radius:12px;">
                        <p style="margin:0; font-size:9px; color:#64748b; font-weight:800;">CONCENTRAÇÃO</p>
                        <p style="margin:5px 0 0 0; font-size:16px; font-weight:900;">${this.lastResult.concentracao} UI/mL</p>
                    </div>
                </div>
                <div style="background:linear-gradient(135deg, #1A3E74, #00838f); color:white; padding:40px; text-align:center; border-radius:25px; box-shadow: 0 10px 20px rgba(26,62,116,0.2);">
                    <p style="margin:0; font-size:12px; font-weight:800; letter-spacing:2px; opacity:0.8;">VOLUME FINAL A ASPIRAR</p>
                    <p style="margin:15px 0 0 0; font-size:64px; font-weight:900;">${this.lastResult.volume} <span style="font-size:24px; opacity:0.6;">mL</span></p>
                </div>
            `;
            
            const canvas = await html2canvas(document.getElementById('pdf-render-template'), { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'pt', 'a4');
            pdf.addImage(imgData, 'PNG', 0, 0, 595, (canvas.height * 595) / canvas.width);
            pdf.save(`Auditoria_${this.lastResult.prescricao}UI.pdf`);
            this.notify('PDF exportado!', 'success');
        },

        async copiarresultado() {
            if (!this.lastResult) return;
            const text = `AUDITORIA CLÍNICA\nPrescrição: ${this.lastResult.prescricao}UI\nConcentração: ${this.lastResult.concentracao}UI/mL\nVolume Final: ${this.lastResult.volume}mL\nData: ${this.lastResult.data}`;
            await navigator.clipboard.writeText(text);
            this.notify('Copiado para a área de transferência!', 'success');
        },

        switchTab(tab) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`pane-${tab}`).classList.remove('hidden');
            document.getElementById(`btn-tab-${tab}`).classList.add('active');
        },

        openModal(title, icon, html) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-icon').className = `fa-solid ${icon} text-xl`;
            document.getElementById('modal-content-area').innerHTML = html;
            document.getElementById('reference-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        },

        closeModal() {
            document.getElementById('reference-modal').classList.add('hidden');
            document.body.style.overflow = '';
        },

        share(plat) {
            const url = encodeURIComponent(window.location.href);
            const urls = {
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${url}`,
                whatsapp: `https://api.whatsapp.com/send?text=Confira esta calculadora profissional: ${url}`,
                linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${url}`
            };
            if (urls[plat]) window.open(urls[plat], '_blank');
        },

        notify(msg, type) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = `toast-msg border-l-4 ${type === 'success' ? 'border-green-500' : type === 'error' ? 'border-red-500' : 'border-nurse-secondary'}`;
            toast.innerHTML = `<span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
    };

    window.onload = () => SYSTEM.init();
  </script>
</body>
</html>
